<!-- templates/manage_files.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>文件管理 - {{ service.name }} | CODEHOST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CodeMirror 核心 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/theme/dracula.min.css">
    
    <!-- CodeMirror 插件 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/search/matchesonscrollbar.min.css">
    
    <style>
        /* 编辑器增强样式 */
        .CodeMirror {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            height: 500px;
            border-radius: 0 0 8px 8px;
            transition: transform 0.3s ease;
        }
        
        /* 移动端触摸优化 */
        .CodeMirror-scroll {
            -webkit-overflow-scrolling: touch;
        }
        
        /* 搜索面板 */
        .CodeMirror-search-field {
            background: #2d2d3d;
            color: white;
            border: 1px solid #4f46e5;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
        }
        
        /* 全屏模式 */
        .CodeMirror-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: auto;
            z-index: 9999;
            background: #1a1a2e;
        }
        
        /* 触摸手势提示 */
        .gesture-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.6; }
        }
        
        /* 缩放控制 */
        .zoom-controls {
            position: fixed;
            right: 20px;
            bottom: 80px;
            background: rgba(30, 30, 40, 0.9);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            border: 1px solid rgba(79, 70, 229, 0.3);
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(79, 70, 229, 0.2);
            border: 1px solid rgba(79, 70, 229, 0.4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .zoom-btn:hover {
            background: rgba(79, 70, 229, 0.4);
            transform: scale(1.1);
        }
        
        /* 快速操作菜单 */
        .quick-actions {
            position: fixed;
            left: 20px;
            bottom: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .action-btn {
            padding: 12px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>
<body>
    <!-- 网格背景 -->
    <div class="grid-bg"></div>
    
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>CODEHOST</span>
        </div>
        <div class="nav-actions">
            <a href="{{ url_for('index') }}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                <span class="hide-mobile">返回</span>
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- 项目信息 -->
        <div class="card">
            <div class="project-header">
                <h2><i class="fas fa-folder"></i> {{ service.name }}</h2>
                <div class="status {{ 'online' if service.pages_url else 'offline' }}">
                    <i class="fas fa-circle"></i>
                    {{ '已部署' if service.pages_url else '未部署' }}
                </div>
            </div>
            
            {% if service.pages_url %}
            <div class="project-url">
                <a href="{{ service.pages_url }}" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt"></i>
                    访问网站
                </a>
            </div>
            {% endif %}
        </div>

        <!-- 编辑器区域 -->
        <div id="editorContainer" class="card" style="display: none;">
            <div class="editor-header">
                <div class="editor-title">
                    <i class="fas fa-edit"></i>
                    <span id="currentFile">正在编辑</span>
                </div>
                <div class="editor-tools">
                    <button class="tool-btn" onclick="searchInEditor()" title="搜索">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="tool-btn" onclick="replaceInEditor()" title="替换">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="tool-btn" onclick="toggleFullscreen()" title="全屏">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="tool-btn" onclick="saveFile()" title="保存">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="tool-btn" onclick="closeEditor()" title="关闭">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <textarea id="codeEditor"></textarea>
        </div>

        <!-- 文件管理区域 -->
        <div id="fileManager">
            <!-- 搜索和过滤 -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="搜索文件..." oninput="filterFiles()">
                <button class="tool-btn" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 文件列表 -->
            <div id="fileList" class="file-list">
                {% for file in files %}
                <div class="file-item" data-filename="{{ file.filename }}" data-type="{{ file.file_type }}">
                    <div class="file-icon">
                        {% if file.filename.endswith('.html') %}
                            <i class="fab fa-html5"></i>
                        {% elif file.filename.endswith('.css') %}
                            <i class="fab fa-css3-alt"></i>
                        {% elif file.filename.endswith('.js') %}
                            <i class="fab fa-js"></i>
                        {% elif 'image' in file.file_type %}
                            <i class="fas fa-image"></i>
                        {% elif file.filename == '.nojekyll' %}
                            <i class="fas fa-cog"></i>
                        {% else %}
                            <i class="fas fa-file"></i>
                        {% endif %}
                    </div>
                    
                    <div class="file-info">
                        <div class="file-name">{{ file.filename }}</div>
                        <div class="file-size">{{ (file.size/1024)|round(1) }} KB</div>
                    </div>
                    
                    <div class="file-actions">
                        {% if file.filename.endswith(('.html', '.css', '.js', '.txt', '.json', '.md')) %}
                        <button class="tool-btn" onclick="editFile('{{ file.filename }}', {{ file.id }})" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                        <button class="tool-btn" onclick="confirmDelete({{ file.id }}, '{{ file.filename }}')" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- 上传区域 -->
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">拖拽文件或点击上传</div>
                <div class="upload-hint">支持 HTML, CSS, JavaScript, 图片等</div>
                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
            </div>
        </div>
    </div>

    <!-- 缩放控制 -->
    <div class="zoom-controls" id="zoomControls" style="display: none;">
        <button class="zoom-btn" onclick="zoomIn()" title="放大">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="zoom-btn" onclick="resetZoom()" title="重置">
            <i class="fas fa-search"></i>
        </button>
        <button class="zoom-btn" onclick="zoomOut()" title="缩小">
            <i class="fas fa-search-minus"></i>
        </button>
    </div>

    <!-- 快速操作 -->
    <div class="quick-actions">
        <button class="action-btn" onclick="createNewFile()" title="新建文件">
            <i class="fas fa-file-plus"></i>
        </button>
        <button class="action-btn" onclick="refreshFiles()" title="刷新">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- 触摸手势提示 -->
    <div class="gesture-hint" id="gestureHint">
        <i class="fas fa-hands"></i>
        <span>双指缩放编辑区</span>
    </div>

    <!-- CodeMirror 脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.js"></script>
    
    <!-- 语言模式 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/clike/clike.min.js"></script>
    
    <!-- 插件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/scroll/annotatescrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/search/matchesonscrollbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/fold/xml-fold.min.js"></script>
    
    <script>
        // 全局变量
        let editor = null;
        let currentServiceId = {{ service.id }};
        let currentFileId = null;
        let currentFileName = '';
        let zoomLevel = 1;
        
        // 初始化编辑器
        function initEditor(content, mode) {
            const textarea = document.getElementById('codeEditor');
            
            if (editor) {
                editor.toTextArea();
            }
            
            editor = CodeMirror.fromTextArea(textarea, {
                value: content,
                mode: mode,
                theme: 'dracula',
                lineNumbers: true,
                lineWrapping: true,
                autofocus: true,
                smartIndent: true,
                tabSize: 2,
                indentWithTabs: false,
                electricChars: true,
                autoCloseBrackets: true,
                autoCloseTags: true,
                matchBrackets: true,
                showCursorWhenSelecting: true,
                styleActiveLine: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                
                // 移动端优化
                touch: true,
                autocorrect: true,
                autocapitalize: true
            });
            
            // 添加搜索插件
            CodeMirror.commands.find = function(cm) {
                cm.state.search = new SearchState();
                showSearchField(cm);
            };
            
            // 触摸手势支持
            setupTouchGestures();
            
            // 显示缩放控制
            document.getElementById('zoomControls').style.display = 'flex';
            
            // 刷新编辑器
            editor.refresh();
        }
        
        // 触摸手势支持
        function setupTouchGestures() {
            let initialDistance = 0;
            let editorElement = editor.getWrapperElement();
            
            editorElement.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                }
            });
            
            editorElement.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    
                    let currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    if (initialDistance > 0) {
                        let scale = currentDistance / initialDistance;
                        if (scale > 1.2) {
                            zoomIn();
                            initialDistance = currentDistance;
                        } else if (scale < 0.8) {
                            zoomOut();
                            initialDistance = currentDistance;
                        }
                    }
                }
            });
        }
        
        // 缩放功能
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 2.0);
            updateZoom();
        }
        
        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            updateZoom();
        }
        
        function resetZoom() {
            zoomLevel = 1;
            updateZoom();
        }
        
        function updateZoom() {
            const editorElement = editor.getWrapperElement();
            editorElement.style.transform = `scale(${zoomLevel})`;
            editorElement.style.transformOrigin = 'top left';
            editor.refresh();
            
            // 显示缩放提示
            showToast(`缩放: ${Math.round(zoomLevel * 100)}%`);
        }
        
        // 编辑文件
        async function editFile(filename, fileId) {
            try {
                const response = await fetch(`/api/file-content?service_id=${currentServiceId}&filename=${encodeURIComponent(filename)}`);
                const result = await response.json();
                
                if (result.success) {
                    currentFileId = fileId;
                    currentFileName = filename;
                    
                    // 显示编辑器，隐藏文件管理器
                    document.getElementById('editorContainer').style.display = 'block';
                    document.getElementById('fileManager').style.display = 'none';
                    document.getElementById('currentFile').textContent = filename;
                    
                    // 根据文件类型设置编辑模式
                    let mode = 'text/plain';
                    if (filename.endsWith('.html')) mode = 'htmlmixed';
                    else if (filename.endsWith('.css')) mode = 'css';
                    else if (filename.endsWith('.js')) mode = 'javascript';
                    else if (filename.endsWith('.json')) mode = 'application/json';
                    else if (filename.endsWith('.xml')) mode = 'xml';
                    
                    // 初始化编辑器
                    initEditor(result.content, mode);
                    
                    showToast(`已打开: ${filename}`);
                } else {
                    showToast(`错误: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`加载失败: ${error.message}`, 'error');
            }
        }
        
        // 搜索功能
        function searchInEditor() {
            if (editor) {
                CodeMirror.commands.find(editor);
            }
        }
        
        function replaceInEditor() {
            if (editor) {
                let search = editor.state.search || new SearchState();
                search.query = editor.getSelection();
                editor.state.search = search;
                showSearchField(editor, true);
            }
        }
        
        // 全屏切换
        function toggleFullscreen() {
            const editorContainer = document.getElementById('editorContainer');
            const isFullscreen = editorContainer.classList.contains('fullscreen');
            
            if (!isFullscreen) {
                editorContainer.classList.add('fullscreen');
                document.body.style.overflow = 'hidden';
            } else {
                editorContainer.classList.remove('fullscreen');
                document.body.style.overflow = '';
            }
            
            if (editor) {
                editor.refresh();
            }
        }
        
        // 保存文件
        async function saveFile() {
            if (!editor || !currentFileId) return;
            
            const content = editor.getValue();
            
            try {
                const response = await fetch('/api/save-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_id: currentServiceId,
                        file_id: currentFileId,
                        filename: currentFileName,
                        content: content
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('保存成功');
                    setTimeout(() => {
                        closeEditor();
                    }, 1000);
                } else {
                    showToast(`保存失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`保存失败: ${error.message}`, 'error');
            }
        }
        
        // 关闭编辑器
        function closeEditor() {
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('fileManager').style.display = 'block';
            document.getElementById('zoomControls').style.display = 'none';
            
            if (editor) {
                editor.toTextArea();
                editor = null;
            }
            
            currentFileId = null;
            currentFileName = '';
            zoomLevel = 1;
        }
        
        // 文件搜索
        function filterFiles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const fileItems = document.querySelectorAll('.file-item');
            
            fileItems.forEach(item => {
                const filename = item.dataset.filename.toLowerCase();
                const filetype = item.dataset.type.toLowerCase();
                
                if (filename.includes(searchTerm) || filetype.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterFiles();
        }
        
        // 新建文件
        async function createNewFile() {
            const filename = prompt('输入新文件名（如：style.css）:');
            if (!filename) return;
            
            try {
                const response = await fetch('/api/create-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_id: currentServiceId,
                        filename: filename,
                        content: ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('文件创建成功');
                    setTimeout(() => {
                        editFile(filename, result.file_id);
                    }, 500);
                } else {
                    showToast(`创建失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`创建失败: ${error.message}`, 'error');
            }
        }
        
        // 文件操作
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            uploadFiles(files);
        }
        
        async function uploadFiles(fileList) {
            const formData = new FormData();
            for (let file of fileList) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch(`/service/${currentServiceId}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`上传成功 ${result.uploaded_files?.length || 0} 个文件`);
                    refreshFiles();
                } else {
                    showToast(`上传失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`上传失败: ${error.message}`, 'error');
            }
        }
        
        async function refreshFiles() {
            try {
                const response = await fetch(`/service/${currentServiceId}/files`);
                const result = await response.json();
                
                if (result.success) {
                    // 重新加载页面
                    location.reload();
                }
            } catch (error) {
                showToast(`刷新失败: ${error.message}`, 'error');
            }
        }
        
        function confirmDelete(fileId, filename) {
            if (confirm(`确定删除文件 "${filename}" 吗？`)) {
                deleteFile(fileId);
            }
        }
        
        async function deleteFile(fileId) {
            try {
                const response = await fetch(`/service/${currentServiceId}/file/${fileId}/delete`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('文件已删除');
                    refreshFiles();
                } else {
                    showToast(`删除失败: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`删除失败: ${error.message}`, 'error');
            }
        }
        
        // 消息提示
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 隐藏手势提示
            setTimeout(() => {
                document.getElementById('gestureHint').style.display = 'none';
            }, 5000);
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 's':
                            e.preventDefault();
                            if (editor) saveFile();
                            break;
                        case 'f':
                            e.preventDefault();
                            if (editor) searchInEditor();
                            break;
                        case 'h':
                            e.preventDefault();
                            if (editor) replaceInEditor();
                            break;
                        case 'e':
                            e.preventDefault();
                            toggleFullscreen();
                            break;
                    }
                }
            });
        });
        
        // SearchState 类（搜索功能）
        function SearchState() {
            this.posFrom = this.posTo = this.lastQuery = this.query = null;
            this.overlay = null;
        }
        
        function showSearchField(cm, replace) {
            let query = cm.state.search && cm.state.search.query;
            let dialog = document.createElement('div');
            dialog.className = 'search-dialog';
            dialog.innerHTML = `
                <div class="search-header">
                    <input type="text" class="search-input" placeholder="搜索..." value="${query || ''}">
                    ${replace ? '<input type="text" class="replace-input" placeholder="替换为...">' : ''}
                </div>
                <div class="search-controls">
                    <button class="search-btn prev">上一个</button>
                    <button class="search-btn next">下一个</button>
                    ${replace ? '<button class="search-btn replace">替换</button>' : ''}
                    <button class="search-btn close">关闭</button>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // 添加事件处理...
        }
    </script>
</body>
</html>